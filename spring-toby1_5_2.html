<h1 id="52-트랜잭션-추상화">5.2 트랜잭션 추상화</h1>

<p>이제 시용자 레벨 관리 기능에 대한 구현을 마쳤고 태스트를 통해 검증도 끝났다. 이쯤 에서 마무리하고 다음 기능으로 넘어가고 싶은데 갑자기 이런 질문이 나왔다.
“정기 사용자 레벨 관리 작업을 수행하는 도중에 네트워크가 끊기거나 서버에 장애가 생겨서 작업을 완료할 수 없다면 그때까지 변경된 λF용자의 레벨은 그대로 둘까요?
아니면 모두 초기 상태로 되돌려 놓아야 할까요?”
이 시스템을 사용할 고객과 개발팀의 열띤 토론 끝에 사용자 레벨 조정 작업은 중간에 문제가 발생해서 작업이 중단된다면 그때까지 진행된 변경 작업도 모두 취소시키도록 결정했다. 일부 사용자는 레벨이 조정됐는데 일부는 안 됐다면 사용자의 반발이 심할 것으로 예상되기 때문이다. 민감한 일부 사용자가 차별받는다고 오해하게 만드는 것보다는 차라리 시스탬 장애가 있어서 레벨 변경 작업을 못했다고 공지하고 다음 날 다시 시도하는 편이 나을 것이다.</p>

<h2 id="521-모-아니면-도">5.2.1 모 아니면 도</h2>

<p>그렇다면， 지금까지 만든 사용자 레벨 업그레이드 코드는 어떻게 동작할지 궁금해진다.
모든 사용자에 대해 업그레이드 작업을 진행하다가 중간에 예외가 발생해서 작엽이 중단된다면 어떻게 될까? 이미 변경된 시용자의 레벨은 작업 이전 상태로 돌아갈까? 아니면 바뀐 채로 남아 있을까?
태스트를 만들어서 확인해보자. 그런데 이번 태스트는 간단하지 않다. 예외적인 상황을 작업 중간에 강제로 발생시켜야 하기 때문이다. 테스트 시나리오를 생각해보자.
일단 5 명의 사용자 정보를 DB 에 넣는다. 그리고 업그레이드 작업을 수행하다가 중간 에서 예외가 발생되게 만든다. 시스템 예외상황을 만들면 더 좋겠지만 l 초도 안 걸리는 짧은 업그레이드 작업 중간에 DB 서벼를 다운시키거나 네트워크를끊는등의 강제적인 장애상황을 연출하는 건 불가능하다. 게다가 테스트의 기본은 자동화된 테스트여야 하니 사람이 간섭히는 것은 좋은 생각이 아니다. 이보다는 싼H 가 발생했을 때 일어나는 현상 중의 하나인 예외가 던져지는 상황을 의도적으로 만드는 게 나을 것이다.</p>

<h3 id="테스트용-userservice-대역">테스트용 UserService 대역</h3>

<p>어떻게 작업 중간에 예외를 강제로 만들 수 있을까? 가장 쉬운 방법은 예외를 강제로 발생시키도록 애플리케이션 코드를 수정히는 것이다. 하지만 태스트를 위해 코드를 함</p>

<h3 id="강제-예외-발생을-통한-테스트">강제 예외 발생을 통한 테스트</h3>

<h3 id="테스트실패의원인">테스트실패의원인</h3>

<h2 id="522-트랜잭션-경계설정">5.2.2 트랜잭션 경계설정</h2>

<h3 id="jdbc-트랜잭션의-트랜잭션-경계설정">JDBC 트랜잭션의 트랜잭션 경계설정</h3>

<h3 id="userservice와-userdao의-트랜잭션-문제">UserService와 UserDao의 트랜잭션 문제</h3>

<h3 id="비즈니스-로직-내의-트랜잭션-경계설정">비즈니스 로직 내의 트랜잭션 경계설정</h3>

<h3 id="userservice-트랜잭션-경계설정의-문제점">UserService 트랜잭션 경계설정의 문제점</h3>

<h2 id="523-트랜잭션동기화">5.2.3 트랜잭션동기화</h2>

<h3 id="connection-파라미터-제거">Connection 파라미터 제거</h3>

<h3 id="트랜잭션동기화적용">트랜잭션동기화적용</h3>

<h3 id="트랜잭션테스트보완">트랜잭션테스트보완</h3>

<h3 id="jdbctemplate과-트랜잭션-동기화">JdbcTemplate과 트랜잭션 동기화</h3>

<h2 id="524-트랜잭션-서비스-추상화">5.2.4 트랜잭션 서비스 추상화</h2>

<h3 id="기술과-환경에-종속되는-트랜잭션-경계설정-코드">기술과 환경에 종속되는 트랜잭션 경계설정 코드</h3>

<h3 id="트랜잭션-api의-의존관계-문제와-해결책">트랜잭션 API의 의존관계 문제와 해결책</h3>

<h3 id="스프링의-트랜잭선-서비스-추4i간확">스프링의 트랜잭선 서비스 추4i간확</h3>

<h3 id="트랜잭션-기술-설정의-분리">트랜잭션 기술 설정의 분리</h3>

