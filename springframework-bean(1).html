<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>스프링 bean생성원리 분석(1)</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <!--custom.css -->
    <link rel="stylesheet" type="text/css" href="/assets/built/custom.css" />

    <!--web font-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/nanumgothic.css">

    <!--font Awesome-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <!--syntax.css 추가-->
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="IT" />
    <link rel="shortcut icon" href="https://seongtaekkim.github.io/assets/built/images/favicon.jpg" type="image/png" />
    <link rel="canonical" href="https://seongtaekkim.github.io/springframework-bean(1)" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="웹개발자" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="스프링 bean생성원리 분석(1)" />
    <meta property="og:description" content="– 스프링 따라하기 – springframework - 따라하기 springframework - 아키텍처 springframework - bean생성원리 분석(1) 개요 SpringFramework의 AnnotationConfigApplicationContext 생성을 통한 빈 등록 및 빈 생성 절차를 알아보자. SpringTestApplication.java ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class); String[] beanNames = context.getBeanDefinitionNames(); for (String name : beanNames) { System.out.println(name); } @Configuration을 정의한 AppConfig.java를 이용해서 AnnotationConfigApplicationContext 를" />
    <meta property="og:url" content="https://seongtaekkim.github.io/springframework-bean(1)" />
    <meta property="og:image" content="https://seongtaekkim.github.io/assets/built/images/spring-framework1.png" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2021-09-19T04:36:01+09:00" />
    <meta property="article:modified_time" content="2021-09-19T04:36:01+09:00" />
    <meta property="article:tag" content="Spring" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="스프링 bean생성원리 분석(1)" />
    <meta name="twitter:description" content="– 스프링 따라하기 – springframework - 따라하기 springframework - 아키텍처 springframework - bean생성원리 분석(1) 개요 SpringFramework의 AnnotationConfigApplicationContext 생성을 통한 빈 등록 및 빈 생성 절차를 알아보자. SpringTestApplication.java ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class); String[] beanNames = context.getBeanDefinitionNames(); for (String name : beanNames) { System.out.println(name); } @Configuration을 정의한 AppConfig.java를 이용해서 AnnotationConfigApplicationContext 를" />
    <meta name="twitter:url" content="https://seongtaekkim.github.io/" />
    <meta name="twitter:image" content="https://seongtaekkim.github.io/assets/built/images/spring-framework1.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="웹개발자" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Spring" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "웹개발자",
        "logo": "https://seongtaekkim.github.io/"
    },
    "url": "https://seongtaekkim.github.io/springframework-bean(1)",
    "image": {
        "@type": "ImageObject",
        "url": "https://seongtaekkim.github.io/assets/built/images/spring-framework1.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://seongtaekkim.github.io/springframework-bean(1)"
    },
    "description": "– 스프링 따라하기 – springframework - 따라하기 springframework - 아키텍처 springframework - bean생성원리 분석(1) 개요 SpringFramework의 AnnotationConfigApplicationContext 생성을 통한 빈 등록 및 빈 생성 절차를 알아보자. SpringTestApplication.java ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class); String[] beanNames = context.getBeanDefinitionNames(); for (String name : beanNames) { System.out.println(name); } @Configuration을 정의한 AppConfig.java를 이용해서 AnnotationConfigApplicationContext 를"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="스프링 bean생성원리 분석(1)" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://seongtaekkim.github.io/">웹개발자</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-spring" role="menuitem"><a href="/tag/spring/">spring</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/java/">java</a></li>
    <li class="nav-archive" role="menuitem">
        <a href="/archive.html">All Posts</a>
    </li>
    <li class="nav-archive" role="menuitem">
        <a href="/author_archive.html">Tag별 Posts</a>
    </li>
</ul>
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
        </div>
        
            <a class="subscribe-button" href="#subscribe">Search</a>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-spring post tag-spring ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="19 September 2021">19 September 2021</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/spring/'>SPRING</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">스프링 bean생성원리 분석(1)</h1>
            </header>

<!-- 블로그 글 입장 시 커버이미지 표시
           
            <figure class="post-full-image" style="background-image: url(/assets/built/images/spring-framework1.png)">
            </figure>
            -->

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p><span class="table-of-contents-list">– 스프링 따라하기 –</span></p>
<ul class="table-of-contents-list">
    <li><a href="./springframework-remake">springframework - 따라하기</a></li>
    <li><a href="./springframework-architecture">springframework - 아키텍처</a></li>
    <li><a href="./springframework-bean(1)">springframework - bean생성원리 분석(1)</a></li>
</ul>

<p><br /><br /><br /></p>

<h3 id="개요">개요</h3>
<p>SpringFramework의 <code class="language-plaintext highlighter-rouge">AnnotationConfigApplicationContext  </code>생성을 통한 빈 등록 및  빈 생성 절차를 알아보자.
<br /><br /><br /></p>

<h4 id="springtestapplicationjava">SpringTestApplication.java</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">AppConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">String</span><span class="o">[]</span> <span class="n">beanNames</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">name</span> <span class="o">:</span> <span class="n">beanNames</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>@Configuration을 정의한 AppConfig.java를 이용해서 <code class="language-plaintext highlighter-rouge">AnnotationConfigApplicationContext</code> 를 생성한다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">AnnotationConfigApplicationContext</code> 를 생성할 때 빈이 등록,생성되는데 디버깅을 통해 대략적인 순서를 알아보자.
<br /><br /></p>
  </li>
</ul>

<h4 id="annotationconfigapplicationcontextjava">AnnotationConfigApplicationContext.java</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">componentClasses</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">();</span>
   <span class="n">register</span><span class="o">(</span><span class="n">componentClasses</span><span class="o">);</span>
   <span class="n">refresh</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>생성자 코드 중에 <code class="language-plaintext highlighter-rouge">register</code>메서드는  빈 등록, <code class="language-plaintext highlighter-rouge">refresh</code> 메서드는 빈 생성을 담당한다.
<br /><br /></li>
</ul>

<h3 id="1-register-메서드---빈-등록">1. register 메서드 - 빈 등록</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">componentClasses</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">Assert</span><span class="o">.</span><span class="na">notEmpty</span><span class="o">(</span><span class="n">componentClasses</span><span class="o">,</span> <span class="s">"At least one component class must be specified"</span><span class="o">);</span>
   <span class="nc">StartupStep</span> <span class="n">registerComponentClass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getApplicationStartup</span><span class="o">().</span><span class="na">start</span><span class="o">(</span><span class="s">"spring.context.component-classes.register"</span><span class="o">)</span>
         <span class="o">.</span><span class="na">tag</span><span class="o">(</span><span class="s">"classes"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">componentClasses</span><span class="o">));</span>
   <span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">componentClasses</span><span class="o">);</span>
   <span class="n">registerComponentClass</span><span class="o">.</span><span class="na">end</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>this.reader.register(componentClasses); 메서드로 이동하면 , <code class="language-plaintext highlighter-rouge">AnnotatedBeanDefinitionReader</code>클래스로 이동한다.
<br /><br /><br /></li>
</ul>

<h4 id="annotatedbeandefinitionreaderjava">AnnotatedBeanDefinitionReader.java</h4>

<ul>
  <li>상단 주석을 보면, Register a bean from the given bean class, deriving its metadata from class-declared annotations. 이라는 표현이 있다.  프로그래머가 annotation으로 정의한 빈을 등록하는 곳 같다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">doRegisterBean</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
      <span class="nd">@Nullable</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;[]</span> <span class="n">qualifiers</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">supplier</span><span class="o">,</span>
      <span class="nd">@Nullable</span> <span class="nc">BeanDefinitionCustomizer</span><span class="o">[]</span> <span class="n">customizers</span><span class="o">)</span> <span class="o">{</span>

   <span class="nc">AnnotatedGenericBeanDefinition</span> <span class="n">abd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotatedGenericBeanDefinition</span><span class="o">(</span><span class="n">beanClass</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">abd</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">()))</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="n">abd</span><span class="o">.</span><span class="na">setInstanceSupplier</span><span class="o">(</span><span class="n">supplier</span><span class="o">);</span>
   <span class="nc">ScopeMetadata</span> <span class="n">scopeMetadata</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">scopeMetadataResolver</span><span class="o">.</span><span class="na">resolveScopeMetadata</span><span class="o">(</span><span class="n">abd</span><span class="o">);</span>
   <span class="n">abd</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">scopeMetadata</span><span class="o">.</span><span class="na">getScopeName</span><span class="o">());</span>
   <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">name</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">beanNameGenerator</span><span class="o">.</span><span class="na">generateBeanName</span><span class="o">(</span><span class="n">abd</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">));</span>

   <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">processCommonDefinitionAnnotations</span><span class="o">(</span><span class="n">abd</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">qualifiers</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">qualifier</span> <span class="o">:</span> <span class="n">qualifiers</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="nc">Primary</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">qualifier</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">abd</span><span class="o">.</span><span class="na">setPrimary</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Lazy</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">qualifier</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">abd</span><span class="o">.</span><span class="na">setLazyInit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
            <span class="n">abd</span><span class="o">.</span><span class="na">addQualifier</span><span class="o">(</span><span class="k">new</span> <span class="nc">AutowireCandidateQualifier</span><span class="o">(</span><span class="n">qualifier</span><span class="o">));</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">customizers</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">BeanDefinitionCustomizer</span> <span class="n">customizer</span> <span class="o">:</span> <span class="n">customizers</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">customizer</span><span class="o">.</span><span class="na">customize</span><span class="o">(</span><span class="n">abd</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="nc">BeanDefinitionHolder</span> <span class="n">definitionHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">abd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="n">definitionHolder</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">applyScopedProxyMode</span><span class="o">(</span><span class="n">scopeMetadata</span><span class="o">,</span> <span class="n">definitionHolder</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
   <span class="nc">BeanDefinitionReaderUtils</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">definitionHolder</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>마지막 줄의 <code class="language-plaintext highlighter-rouge">BeanDefinitionReaderUtils</code> 클래스의 <code class="language-plaintext highlighter-rouge">registerBeanDefinition</code> 메서드를 통해 빈이 등록된다.</li>
</ul>

<h4 id="genericapplicationcontextjava">GenericApplicationContext.java</h4>

<ul>
  <li>주석에 <code class="language-plaintext highlighter-rouge">BeanDefinitionRegistry</code> 의 구현체라고 되어있다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//---------------------------------------------------------------------</span>
<span class="c1">// Implementation of BeanDefinitionRegistry</span>
<span class="c1">//---------------------------------------------------------------------</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">beanDefinition</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>

   <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>this.beanFactory는 <code class="language-plaintext highlighter-rouge">DefaultListableBeanFactory</code> 타입의 상수객체이다.
    <ul>
      <li>private final DefaultListableBeanFactory beanFactory;
<br /><br /><br /></li>
    </ul>
  </li>
</ul>

<h4 id="defaultlistablebeanfactoryjava">DefaultListableBeanFactory.java</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">DefaultListableBeanFactory</code> 클래스는 bean을 등록,조회하는 역할을 한다. (등록된 빈도 정의되어 있다.)
    <ul>
      <li>빈 등록 객체 : Map&lt;String, BeanDefinition&gt; beanDefinitionMap</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//---------------------------------------------------------------------</span>
<span class="c1">// Implementation of BeanDefinitionRegistry interface</span>
<span class="c1">//---------------------------------------------------------------------</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">beanDefinition</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>

   <span class="nc">Assert</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="s">"Bean name must not be empty"</span><span class="o">);</span>
   <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">,</span> <span class="s">"BeanDefinition must not be null"</span><span class="o">);</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">beanDefinition</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="o">((</span><span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="n">beanDefinition</span><span class="o">).</span><span class="na">validate</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
               <span class="s">"Validation of bean definition failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="nc">BeanDefinition</span> <span class="n">existingDefinition</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">existingDefinition</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">isAllowBeanDefinitionOverriding</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionOverrideException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">,</span> <span class="n">existingDefinition</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">existingDefinition</span><span class="o">.</span><span class="na">getRole</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getRole</span><span class="o">())</span> <span class="o">{</span>
         <span class="c1">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Overriding user-defined bean definition for bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
                  <span class="s">"' with a framework-generated bean definition: replacing ["</span> <span class="o">+</span>
                  <span class="n">existingDefinition</span> <span class="o">+</span> <span class="s">"] with ["</span> <span class="o">+</span> <span class="n">beanDefinition</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">beanDefinition</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">existingDefinition</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Overriding bean definition for bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
                  <span class="s">"' with a different definition: replacing ["</span> <span class="o">+</span> <span class="n">existingDefinition</span> <span class="o">+</span>
                  <span class="s">"] with ["</span> <span class="o">+</span> <span class="n">beanDefinition</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Overriding bean definition for bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
                  <span class="s">"' with an equivalent definition: replacing ["</span> <span class="o">+</span> <span class="n">existingDefinition</span> <span class="o">+</span>
                  <span class="s">"] with ["</span> <span class="o">+</span> <span class="n">beanDefinition</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">hasBeanCreationStarted</span><span class="o">())</span> <span class="o">{</span>
         <span class="c1">// Cannot modify startup-time collection elements anymore (for stable iteration)</span>
         <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">updatedDefinitions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">updatedDefinitions</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">);</span>
            <span class="n">updatedDefinitions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span> <span class="o">=</span> <span class="n">updatedDefinitions</span><span class="o">;</span>
            <span class="n">removeManualSingletonName</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="c1">// Still in startup registration phase</span>
         <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
         <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
         <span class="n">removeManualSingletonName</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">this</span><span class="o">.</span><span class="na">frozenBeanDefinitionNames</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">existingDefinition</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">containsSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">resetBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">isConfigurationFrozen</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">clearByTypeCache</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>BeanDefinition existingDefinition = this.beanDefinitionMap.get(beanName);</p>
  </li>
  <li>
    <p>빈이름이 등록되어있는지 조회하여 존재하지 않으면, 빈을 등록한다.</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
<span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
</code></pre></div>    </div>
    <p><br /><br /><br /></p>
  </li>
  <li>register 구조 참조
<img src="assets/built/images/spring/spring-bean1.png" align="left" width="100%" /></li>
</ul>

<p><br /><br /><br /></p>

<h3 id="2-refresh-메서드---빈-생성">2. refresh 메서드 - 빈 생성</h3>

<h4 id="abstractapplicationcontextjava">AbstractApplicationContext.java</h4>

<ul>
  <li>finishBeanFactoryInitialization(beanFactory) 메서드는 실제 빈을 생성하는 로직이다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">,</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
   <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">startupShutdownMonitor</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">StartupStep</span> <span class="n">contextRefresh</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationStartup</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"spring.context.refresh"</span><span class="o">);</span>

      <span class="c1">// Prepare this context for refreshing.</span>
      <span class="n">prepareRefresh</span><span class="o">();</span>

      <span class="c1">// Tell the subclass to refresh the internal bean factory.</span>
      <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="o">();</span>

      <span class="c1">// Prepare the bean factory for use in this context.</span>
      <span class="n">prepareBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

      <span class="k">try</span> <span class="o">{</span>
         <span class="c1">// Allows post-processing of the bean factory in context subclasses.</span>
         <span class="n">postProcessBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

         <span class="nc">StartupStep</span> <span class="n">beanPostProcess</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationStartup</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"spring.context.beans.post-process"</span><span class="o">);</span>
         <span class="c1">// Invoke factory processors registered as beans in the context.</span>
         <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

         <span class="c1">// Register bean processors that intercept bean creation.</span>
         <span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
         <span class="n">beanPostProcess</span><span class="o">.</span><span class="na">end</span><span class="o">();</span>

         <span class="c1">// Initialize message source for this context.</span>
         <span class="n">initMessageSource</span><span class="o">();</span>

         <span class="c1">// Initialize event multicaster for this context.</span>
         <span class="n">initApplicationEventMulticaster</span><span class="o">();</span>

         <span class="c1">// Initialize other special beans in specific context subclasses.</span>
         <span class="n">onRefresh</span><span class="o">();</span>

         <span class="c1">// Check for listener beans and register them.</span>
         <span class="n">registerListeners</span><span class="o">();</span>

         <span class="c1">// Instantiate all remaining (non-lazy-init) singletons.</span>
         <span class="n">finishBeanFactoryInitialization</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

         <span class="c1">// Last step: publish corresponding event.</span>
         <span class="n">finishRefresh</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Exception encountered during context initialization - "</span> <span class="o">+</span>
                  <span class="s">"cancelling refresh attempt: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="c1">// Destroy already created singletons to avoid dangling resources.</span>
         <span class="n">destroyBeans</span><span class="o">();</span>

         <span class="c1">// Reset 'active' flag.</span>
         <span class="n">cancelRefresh</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>

         <span class="c1">// Propagate exception to caller.</span>
         <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="k">finally</span> <span class="o">{</span>
         <span class="c1">// Reset common introspection caches in Spring's core, since we</span>
         <span class="c1">// might not ever need metadata for singleton beans anymore...</span>
         <span class="n">resetCommonCaches</span><span class="o">();</span>
         <span class="n">contextRefresh</span><span class="o">.</span><span class="na">end</span><span class="o">();</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="finishbeanfactoryinitialization-메서드">finishBeanFactoryInitialization 메서드</h4>

<ul>
  <li>주석 : Finish the initialization of this context’s bean factory<strong>, initializing all remaining singleton beans.</strong></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finishBeanFactoryInitialization</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// Initialize conversion service for this context.</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsBean</span><span class="o">(</span><span class="no">CONVERSION_SERVICE_BEAN_NAME</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
         <span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="no">CONVERSION_SERVICE_BEAN_NAME</span><span class="o">,</span> <span class="nc">ConversionService</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">setConversionService</span><span class="o">(</span>
            <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">CONVERSION_SERVICE_BEAN_NAME</span><span class="o">,</span> <span class="nc">ConversionService</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
   <span class="o">}</span>

   <span class="c1">// Register a default embedded value resolver if no BeanFactoryPostProcessor</span>
   <span class="c1">// (such as a PropertySourcesPlaceholderConfigurer bean) registered any before:</span>
   <span class="c1">// at this point, primarily for resolution in annotation attribute values.</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">hasEmbeddedValueResolver</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">addEmbeddedValueResolver</span><span class="o">(</span><span class="n">strVal</span> <span class="o">-&gt;</span> <span class="n">getEnvironment</span><span class="o">().</span><span class="na">resolvePlaceholders</span><span class="o">(</span><span class="n">strVal</span><span class="o">));</span>
   <span class="o">}</span>

   <span class="c1">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span>
   <span class="nc">String</span><span class="o">[]</span> <span class="n">weaverAwareNames</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="nc">LoadTimeWeaverAware</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">weaverAwareName</span> <span class="o">:</span> <span class="n">weaverAwareNames</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">getBean</span><span class="o">(</span><span class="n">weaverAwareName</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="c1">// Stop using the temporary ClassLoader for type matching.</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">setTempClassLoader</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

   <span class="c1">// Allow for caching all bean definition metadata, not expecting further changes.</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">freezeConfiguration</span><span class="o">();</span>

   <span class="c1">// Instantiate all remaining (non-lazy-init) singletons.</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">preInstantiateSingletons</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>beanFactory.preInstantiateSingletons(); 메서드에서 싱글톤 객체를 생성한다.
<br /><br /><br /></li>
</ul>

<h4 id="defaultlistablebeanfactoryjava-1">DefaultListableBeanFactory.java</h4>

<ul>
  <li>1번의 register메서드에서 등록한 this.beanDefinitionNames를 대상으로 빈 생성을 수행한다.</li>
  <li>isFactoryBean(beanName) 가 false이므로 getBean(beanName); 메서드를 수행한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">preInstantiateSingletons</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>

   <span class="c1">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span>
   <span class="c1">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">beanNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">);</span>

   <span class="c1">// Trigger initialization of all non-lazy singleton beans...</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">beanNames</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">RootBeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">bd</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">bd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bd</span><span class="o">.</span><span class="na">isLazyInit</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">isFactoryBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">getBean</span><span class="o">(</span><span class="no">FACTORY_BEAN_PREFIX</span> <span class="o">+</span> <span class="n">beanName</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="k">instanceof</span> <span class="nc">FactoryBean</span><span class="o">)</span> <span class="o">{</span>
               <span class="nc">FactoryBean</span><span class="o">&lt;?&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">bean</span><span class="o">;</span>
               <span class="kt">boolean</span> <span class="n">isEagerInit</span><span class="o">;</span>
               <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">factory</span> <span class="k">instanceof</span> <span class="nc">SmartFactoryBean</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">isEagerInit</span> <span class="o">=</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
                        <span class="o">(</span><span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;)</span> <span class="o">((</span><span class="nc">SmartFactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">factory</span><span class="o">)::</span><span class="n">isEagerInit</span><span class="o">,</span>
                        <span class="n">getAccessControlContext</span><span class="o">());</span>
               <span class="o">}</span>
               <span class="k">else</span> <span class="o">{</span>
                  <span class="n">isEagerInit</span> <span class="o">=</span> <span class="o">(</span><span class="n">factory</span> <span class="k">instanceof</span> <span class="nc">SmartFactoryBean</span> <span class="o">&amp;&amp;</span>
                        <span class="o">((</span><span class="nc">SmartFactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">factory</span><span class="o">).</span><span class="na">isEagerInit</span><span class="o">());</span>
               <span class="o">}</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">isEagerInit</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">getBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
               <span class="o">}</span>
            <span class="o">}</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
            <span class="n">getBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>

 <span class="o">....</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>getBean(beanName); 로 이동하여, doGetBean 구현부로 이동한다.</li>
</ul>

<p><br /><br /><br /></p>

<h4 id="abstractbeanfactoryjava---dogetbean-메서드">AbstractBeanFactory.java  &gt; doGetBean 메서드</h4>

<ul>
  <li>싱글톤,프로토타입에 따라 분기하여 객체를 생성한다.</li>
  <li>싱글톤 :  getSingleton 메서드의 콜백메서드인 creaeBean을 살펴보자.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">doGetBean</span><span class="o">(</span>
      <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">requiredType</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">typeCheckOnly</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>

   <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">transformedBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
   <span class="nc">Object</span> <span class="n">beanInstance</span><span class="o">;</span>

   <span class="c1">// Eagerly check singleton cache for manually registered singletons.</span>
   <span class="nc">Object</span> <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">sharedInstance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="o">...</span>
   <span class="o">}</span>

   <span class="k">else</span> <span class="o">{</span>
      <span class="o">...</span>

         <span class="c1">// Create bean instance.</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
               <span class="k">try</span> <span class="o">{</span>
                  <span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
               <span class="o">}</span>
               <span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">// Explicitly remove instance from singleton cache: It might have been put there</span>
                  <span class="c1">// eagerly by the creation process, to allow for circular reference resolution.</span>
                  <span class="c1">// Also remove any beans that received a temporary reference to the bean.</span>
                  <span class="n">destroySingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
                  <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
               <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isPrototype</span><span class="o">())</span> <span class="o">{</span>
           <span class="o">....</span>
         <span class="o">}</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="nf">adaptBeanInstance</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">beanInstance</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="defaultsingletonbeanregistryjava---getsingleton-메서드">DefaultSingletonBeanRegistry.java  &gt; getSingleton 메서드</h4>

<ul>
  <li>singletonObject = singletonFactory.getObject(); 를 통해서 doGetBean메서드의 createBean구현부로 이동가능함.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">ObjectFactory</span><span class="o">&lt;?&gt;</span> <span class="n">singletonFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="s">"Bean name must not be null"</span><span class="o">);</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">Object</span> <span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">.....</span>
                
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">singletonObject</span> <span class="o">=</span> <span class="n">singletonFactory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
					<span class="n">newSingleton</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="o">....</span>
				<span class="o">}</span>
				<span class="o">....</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">newSingleton</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">addSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonObject</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">singletonObject</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="abstractautowirecapablebeanfactoryjava--createbean">AbstractAutowireCapableBeanFactory.java &gt; createBean</h4>

<ul>
  <li>Object beanInstance = doCreateBean(beanName, mbdToUse, args); 으로 이동</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">createBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>

<span class="o">....</span>

   <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Object</span> <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">doCreateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbdToUse</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
         <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Finished creating instance of bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanCreationException</span> <span class="o">|</span> <span class="nc">ImplicitlyAppearedSingletonException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
   <span class="o">}</span>
  <span class="o">....</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="abstractautowirecapablebeanfactoryjava--docreatebean-메서드">AbstractAutowireCapableBeanFactory.java &gt; doCreateBean 메서드</h4>

<ul>
  <li>빈은 BeanWrapper타입으로 감싸서 생성된다.</li>
  <li>instanceWrapper = createBeanInstance(beanName, mbd, args); 으로 이동</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">doCreateBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>

   <span class="c1">// Instantiate the bean.</span>
   <span class="nc">BeanWrapper</span> <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanInstanceCache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">instanceWrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="n">createBeanInstance</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>
 
    <span class="o">....</span>

   <span class="k">return</span> <span class="n">exposedObject</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="abstractautowirecapablebeanfactoryjava--createbeaninstance">AbstractAutowireCapableBeanFactory.java &gt; createBeanInstance</h4>

<ul>
  <li>instantiateBean 메서드로 이동</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">BeanWrapper</span> <span class="nf">createBeanInstance</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// Make sure bean class is actually resolved at this point.</span>

    <span class="o">....</span>

   <span class="c1">// No special handling: simply use no-arg constructor.</span>
   <span class="k">return</span> <span class="nf">instantiateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="abstractautowirecapablebeanfactoryjava--instantiatebean">AbstractAutowireCapableBeanFactory.java &gt; instantiateBean</h4>

<ul>
  <li>getInstantiationStrategy().instantiate(mbd, beanName, this); 으로 이동</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">BeanWrapper</span> <span class="nf">instantiateBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Object</span> <span class="n">beanInstance</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">beanInstance</span> <span class="o">=</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
               <span class="o">(</span><span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;)</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">getInstantiationStrategy</span><span class="o">().</span><span class="na">instantiate</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="k">this</span><span class="o">),</span>
               <span class="n">getAccessControlContext</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">getInstantiationStrategy</span><span class="o">().</span><span class="na">instantiate</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nc">BeanWrapper</span> <span class="n">bw</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BeanWrapperImpl</span><span class="o">(</span><span class="n">beanInstance</span><span class="o">);</span>
      <span class="n">initBeanWrapper</span><span class="o">(</span><span class="n">bw</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">bw</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
            <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Instantiation of bean failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="simpleinstantiationstrategyjava--instantiate">SimpleInstantiationStrategy.java &gt; instantiate</h4>

<ul>
  <li>CGLIB override 검사를 하고, 드디어 인스턴스를 생성한다.</li>
  <li>BeanUtils.instantiateClass(constructorToUse); 으로 이동</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Object</span> <span class="nf">instantiate</span><span class="o">(</span><span class="nc">RootBeanDefinition</span> <span class="n">bd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanFactory</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// Don't override the class with CGLIB if no overrides.</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">bd</span><span class="o">.</span><span class="na">hasMethodOverrides</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">constructorToUse</span><span class="o">;</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">constructorArgumentLock</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">constructorToUse</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Constructor</span><span class="o">&lt;?&gt;)</span> <span class="n">bd</span><span class="o">.</span><span class="na">resolvedConstructorOrFactoryMethod</span><span class="o">;</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">constructorToUse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="na">getBeanClass</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">isInterface</span><span class="o">())</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanInstantiationException</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="s">"Specified class is an interface"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">constructorToUse</span> <span class="o">=</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
                        <span class="o">(</span><span class="nc">PrivilegedExceptionAction</span><span class="o">&lt;</span><span class="nc">Constructor</span><span class="o">&lt;?&gt;&gt;)</span> <span class="nl">clazz:</span><span class="o">:</span><span class="n">getDeclaredConstructor</span><span class="o">);</span>
               <span class="o">}</span>
               <span class="k">else</span> <span class="o">{</span>
                  <span class="n">constructorToUse</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">();</span>
               <span class="o">}</span>
               <span class="n">bd</span><span class="o">.</span><span class="na">resolvedConstructorOrFactoryMethod</span> <span class="o">=</span> <span class="n">constructorToUse</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanInstantiationException</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="s">"No default constructor found"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">constructorToUse</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// Must generate CGLIB subclass.</span>
      <span class="k">return</span> <span class="nf">instantiateWithMethodInjection</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">owner</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="beanutilsjava--instantiateclass-메서드">BeanUtils.java &gt; instantiateClass 메서드</h4>

<ul>
  <li>ReflectionUtils 클래스에서 인스턴스를 생성한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">instantiateClass</span><span class="o">(</span><span class="nc">Constructor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">ctor</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanInstantiationException</span> <span class="o">{</span>
   <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">ctor</span><span class="o">,</span> <span class="s">"Constructor must not be null"</span><span class="o">);</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ReflectionUtils</span><span class="o">.</span><span class="na">makeAccessible</span><span class="o">(</span><span class="n">ctor</span><span class="o">);</span>
      <span class="o">...</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">ctor</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
         <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;=</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="s">"Can't specify more arguments than constructor parameters"</span><span class="o">);</span>
         <span class="nc">Object</span><span class="o">[]</span> <span class="n">argsWithDefaultValues</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">parameterType</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
               <span class="n">argsWithDefaultValues</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">()</span> <span class="o">?</span> <span class="no">DEFAULT_TYPE_VALUES</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">parameterType</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
               <span class="n">argsWithDefaultValues</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="o">}</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="n">ctor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">argsWithDefaultValues</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
  <span class="o">....</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="abstractautowirecapablebeanfactoryjava--initializebean">AbstractAutowireCapableBeanFactory.java &gt; initializeBean</h4>

<ul>
  <li>인스턴스 생성 후,  초기화를 진행한다.</li>
  <li>applyBeanPostProcessorsBeforeInitialization -&gt; invokeInitMethods -&gt; applyBeanPostProcessorsAfterInitialization</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">initializeBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">((</span><span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;)</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
         <span class="n">invokeAwareMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
         <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">},</span> <span class="n">getAccessControlContext</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="n">invokeAwareMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="nc">Object</span> <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsBeforeInitialization</span><span class="o">(</span><span class="n">wrappedBean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">try</span> <span class="o">{</span>
      <span class="n">invokeInitMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">wrappedBean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
            <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">),</span>
            <span class="n">beanName</span><span class="o">,</span> <span class="s">"Invocation of init method failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsAfterInitialization</span><span class="o">(</span><span class="n">wrappedBean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="n">wrappedBean</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="defaultsingletonbeanregistryjava--addsingleton-메서드">DefaultSingletonBeanRegistry.java &gt; addSingleton 메서드</h4>

<ul>
  <li>singletonObjects 객체에 빈을 추가한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">singletonObject</span><span class="o">)</span> <span class="o">{</span>
   <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonObject</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">singletonFactories</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">registeredSingletons</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /><br /><br /></p>

<h4 id="reflesh-구조-참조">reflesh 구조 참조</h4>

<p><img src="assets/built/images/spring/spring-bean2.png" align="left" width="100%" />
<br /><br /><br /></p>

<h3 id="정리">정리</h3>

<p>SpringFramework의 <code class="language-plaintext highlighter-rouge">AnnotationConfigApplicationContext  </code>생성을 통한 빈 등록 및  빈 생성 절차를 알아보았다.</p>

<p>AnnotationConfigApplicationContext 생성자는 register 메서드와 reflesh메서드를 호출한다.</p>

<p><code class="language-plaintext highlighter-rouge">register</code>는 빈 등록업무를 진행한다. <code class="language-plaintext highlighter-rouge">DefaultListableBeanFactory </code>클래스의 Map&lt;String, BeanDefinition&gt; beanDefinitionMap을 통해 등록된다.</p>

<p><code class="language-plaintext highlighter-rouge">reflesh</code>는  beanDefinitionMap에 등록된 빈을 대상으로 생성을 진행한다. <code class="language-plaintext highlighter-rouge">DefaultSingletonBeanRegistry </code>클래스의 private final Map&lt;String, Object&gt; singletonObjects을 통해 등록된다.</p>

<p><br /><br /><br /></p>

<hr />

<h4 id="출처">출처</h4>

<p>1.빈 생성절차</p>

<p>https://private-space.tistory.com/71?category=865490</p>

<p>2.DefaultListableBeanFactory  정리글</p>

<p>https://okky.kr/article/563392</p>


                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
<!--            
                <section class="subscribe-form">
                    <h3 class="subscribe-form-title">Subscribe to 웹개발자</h3>
                    <p>Get the latest posts delivered right to your inbox</p>
                    <span id="searchform" method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  />
    <input class="location" type="hidden" name="location"  />
    <input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" onkeyup="myFunc()"
               id="searchtext" type="text" name="searchtext"
               placeholder="Search..." />
    </div>
    <script type="text/javascript">
        function myFunc() {
            if(event.keyCode == 13) {
                var url = encodeURIComponent($("#searchtext").val());
                location.href = "/search.html?query=" + url;
            }
        }
    </script>
</span>
                </section>
            -->

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/built/images/author-logo.jpg" alt="seongtaekkim" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/seongtaekkim">seongtaekkim</a></h4>
                                
                                    <p>springframework, oracle</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/seongtaekkim">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            var this_page_url = 'https://seongtaekkim.github.io/springframework-bean(1)';
                            var this_page_identifier = '/springframework-bean(1)';
                            var this_page_title = '스프링 bean생성원리 분석(1)';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://xxxxxxxx.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/built/images/cover1.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; 웹개발자 &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/spring/">Spring</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/springframework-architecture">스프링 따라하기</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/springframework-remake">스프링 따라하기</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/spring-toby2_2">토비의스프링2권 2장</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/spring/">
                                
                                    See all 6 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/java-reflection">
                <div class="post-card-image" style="background-image: url(/assets/built/images/bus.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/java-reflection">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Java</span>
                            
                        
                    

                    <h2 class="post-card-title">JAVA CORE - Reflection</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>– JAVA CORE –

    JAVA CORE - JVM


</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/built/images/author-logo.jpg" alt="seongtaekkim" />
                        
                        <span class="post-card-author">
                            <a href="/author/seongtaekkim/">seongtaekkim</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/java-jvm">
                <div class="post-card-image" style="background-image: url(/assets/built/images/bus.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/java-jvm">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Java</span>
                            
                        
                    

                    <h2 class="post-card-title">JAVA CORE - JVM</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>– JAVA CORE –

    JAVA CORE - JVM


</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/built/images/author-logo.jpg" alt="seongtaekkim" />
                        
                        <span class="post-card-author">
                            <a href="/author/seongtaekkim/">seongtaekkim</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://seongtaekkim.github.io/">
            
            <span>웹개발자</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">스프링 bean생성원리 분석(1)</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=%EC%8A%A4%ED%94%84%EB%A7%81+bean%EC%83%9D%EC%84%B1%EC%9B%90%EB%A6%AC+%EB%B6%84%EC%84%9D%281%29&amp;url=https://seongtaekkim.github.io/springframework-bean(1)"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://seongtaekkim.github.io/springframework-bean(1)"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://seongtaekkim.github.io/">웹개발자</a> &copy; 2021</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyllt/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    
    <div id="subscribe" class="subscribe-overlay">
        <a class="subscribe-overlay-close" href="#"></a>
        <div class="subscribe-overlay-content">
            
            <h1 class="subscribe-overlay-title">Search 웹개발자</h1>
            <p class="subscribe-overlay-description">
                lunr.js를 이용한 posts 검색 </p>
            <span id="searchform" method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  />
    <input class="location" type="hidden" name="location"  />
    <input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" onkeyup="myFunc()"
               id="searchtext" type="text" name="searchtext"
               placeholder="Search..." />
    </div>
    <script type="text/javascript">
        function myFunc() {
            if(event.keyCode == 13) {
                var url = encodeURIComponent($("#searchtext").val());
                location.href = "/search.html?query=" + url;
            }
        }
    </script>
</span>
        </div>
    </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-xxxxxxxx-x', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
