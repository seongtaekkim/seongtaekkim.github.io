
~~~ sh

Host‑1 eth1         Leaf‑1           Underlay          Leaf‑2        Host‑2 eth0
┌────┐   ┌────┐   ┌──────┐        ┌────────┐        ┌──────┐   ┌────┐
│L2  │===│eth1│===│ br0  │===>=== │ eth0   │ ===>===│ br0  │===│eth0│
└────┘   │    │   │      │   ▲    │        │    ▲   │      │   └────┘
          └────┘   │Vx10 │   │    └────────┘    │   └──────┘
                   └──────┘   │   UDP 4789+IP   │
                               ▼                ▼
                           VXLAN Encaps     VXLAN Decaps


~~~

## “Dynamic Multicast” 모드 — Host‑1 → Host‑2 Ping

### (Phase 1 = ARP FLOOD,   Phase 2 = ICMP UNICAST)

> **전제 주소**
> 
> - VTEP‑IP Leaf‑1 = **10.1.1.1** Leaf‑2 = **10.1.1.2**
>     
> - VXLAN 인터페이스 : `vxlan10 id 10 group 239.1.1.1` (모두 동일)
>     
> - Host‑1 20.1.1.1 / MAC‑A   Host‑2 20.1.1.2 / MAC‑B



**Phase 1 결과** 

- 두 Leaf FDB 모두 `(MAC‑A,B ⇒ 원격 VTEP‑IP)` 완료
    
- ARP 캐시 : Host‑1 ⟶ MAC‑B, Host‑2 ⟶ MAC‑A
    
- Multicast는 **1‑2 ~ 1‑3** 의 “첫 Flood” 한 번으로 끝.

### Phase 1 ― ARP Flood (캡슐 **Multicast** · FDB 학습 단계)

| #       | 동작                                                                      | Flood?        | 캡슐 Outer IP                                                          | FDB 변화                                                                             | Wireshark 보기                  |
| ------- | ----------------------------------------------------------------------- | ------------- | -------------------------------------------------------------------- | ---------------------------------------------------------------------------------- | ----------------------------- |
| **1‑1** | **Host‑1** → ARP Request “Who has 20.1.1.2?”(Dst MAC ff:ff:ff:ff:ff:ff) | L2 broadcast  | (아직 X)                                                               | Leaf‑1 `br0` : **MAC‑A/port eth1** 학습                                              | `arp`                         |
| **1‑2** | Leaf‑1 `br0` Flood → `vxlan10` 포트에도 전송                                  | 예             | **Src 10.1.1.1 → Dst 239.1.1.1**UDP 4789 + VXLAN(VNI 10) + Inner ARP | —                                                                                  | `ip.dst == 239.1.1.1`         |
| **1‑3** | Underlay 스위치가 **Multicast 복제** → Leaf‑2 `eth0` 도착                       | 예             | 동일                                                                   | —                                                                                  | 동일                            |
| **1‑4** | Leaf‑2 **디캡슐** → `br0` Flood → Host‑2 수신                                | (Inner Flood) | Inner L2만                                                            | Leaf‑2 `br0` : **MAC‑A → dst 10.1.1.1** **등록** (커널이 “캡슐 SrcIP” ⇒ dst VTEP‑IP 로 저장) | `bridge fdb show dev vxlan10` |
| **1‑5** | **Host‑2**, ARP Reply “20.1.1.2 is‑at MAC‑B” (Unicast → MAC‑A)          | L2 unicast    | (아직 X)                                                               | —                                                                                  | `arp`                         |
| **1‑6** | Leaf‑2 lookup   → “MAC‑A ↦ VTEP 10.1.1.1” **존재** → **Unicast 캡슐화**      | Unicast       | **Src 10.1.1.2 → Dst 10.1.1.1**                                      | Leaf‑2 `br0` : **MAC‑B/port eth0** 학습                                              | `ip.dst == 10.1.1.1`          |
| **1‑7** | 캡슐 Underlay → Leaf‑1 도착 → **디캡슐 → Host‑1**                              | —             | —                                                                    | Leaf‑1 FDB : **MAC‑B → dst 10.1.1.2** 등록                                           | `bridge fdb …`                |

### Phase 2 ― ICMP Ping (캡슐 **Unicast** · 데이터 전송 단계)

| #       | 동작                                              | Flood? | 캡슐 Outer IP                                                  | 주 관찰점                |
| ------- | ----------------------------------------------- | ------ | ------------------------------------------------------------ | -------------------- |
| **2‑1** | Host‑1 ICMP Echo (Dst MAC‑B) → Leaf‑1 `br0`     | X      | —                                                            | —                    |
| **2‑2** | Leaf‑1 FDB lookup → **VTEP 10.1.1.2**           | X      | **Src 10.1.1.1 → Dst 10.1.1.2**UDP 4789 + VXLAN + Inner ICMP | `ip.dst == 10.1.1.2` |
| **2‑3** | Underlay 라우팅 → Leaf‑2 `eth0` → **디캡슐 → Host‑2** | X      | —                                                            | ICMP Echo 도착         |
| **2‑4** | Host‑2 ICMP Reply 역과정 (Unicast 캡슐 dst 10.1.1.1) | X      | **Src 10.1.1.2 → Dst 10.1.1.1**                              | Ping 통과              |


### Flood(플러드)란?

| 구분           | 설명                                                                                                      |
| ------------ | ------------------------------------------------------------------------------------------------------- |
| **정의**       | “프레임을 브리지 도메인의 **모든 포트**로 복제·전송” 하는 동작. 목적 MAC 을 모를 때(BUM: Broadcast, Unknown‑unicasts, Multicasts) 사용. |
| **VXLAN 동작** | _Flood & Learn_ 디자인에서는 **멀티캐스트 그룹**으로 한 번만 보내고, 수신 Leaf 가 FDB 적재 후 **Unicast** 로 전환 → 대역폭 절약.           |
| **과제에서 관찰**  | 1‑2 (ARP Request Flood), 1‑4 (디캡 후 Leaf‑2 내부 Flood). 이후 모든 트래픽은 Unicast.                                |

### 결론 — “어느 단계가 Multicast·Unicast인가?”

|단계|Multicast?|이유|
|---|---|---|
|**1‑2, 1‑3**|✅|초기 BUM 트래픽을 **group 239.1.1.1** 으로 Flood|
|나머지(1‑6 이후)|❌ (Unicast)|FDB 가 완성된 뒤엔 **목적 MAC → dst VTEP‑IP** 로 1:1 캡슐|



이렇게 **FLOOD → 학습 → UNI 캐시 트래픽** 구조가 멀티캐스트‑VXLAN의 핵심이며, 과제에서 요구하는 “Dynamic Multicast 모드” 시연 포인트.